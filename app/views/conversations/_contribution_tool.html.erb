<% content_for :header do %>

  <%= javascript_include_tag 'vendor/tiny_mce/jquery.tinymce.js' %>

  <style type="text/css">
    .visible
    {
      position:absolute;
      right:0px;
      top:auto;
    }

    .hidden 
    {
      position:absolute;
      left:-10000px;
      top:auto;
      overflow:hidden;
    }
  </style>

  <script type='text/javascript'> 
    //<![CDATA[

    function init_tiny_mce(JqueryListOfElements){
      $(JqueryListOfElements).tinymce({
        script_url : '/javascripts/vendor/tiny_mce/tiny_mce.js',
        mode : "textareas",
        //theme : "simple",
        theme : "advanced",
        // turned off autoresize because it doesn't seem to work very well
        //plugins : 'autoresize',
        width : '100%',
		theme_advanced_buttons1 : "bold,italic,underline,strikethrough,|,link,unlink,|,bullist,numlist,|,undo,redo,|,cut,copy,paste",
        theme_advanced_buttons2 : "",
        theme_advanced_buttons3 : "",
		theme_advanced_toolbar_location : "top",
		theme_advanced_toolbar_align : "left",
      });
    }

    function clear_contribution_tool_form() {
      $(':input','#contribution_new')
        .not(':button, :submit, :reset, :hidden')
        .val('')
        .removeAttr('checked')
        .removeAttr('selected');
      $('#contribution_content').tinymce().setContent('');
    }

    function get_contribution_parent_id(container) {
        var contribution_id = container.attr('id');
        contribution_id = contribution_id.match(/respond-to-(\d+)/);
        if (contribution_id instanceof Array && contribution_id.length == 2) {
          return contribution_id[1];
        } else {
          return false;
        }
    }

    function show_contribution_tool(container, contribution_id, title) {
      $('#contribution_content').tinymce().remove();
      $('#contribution_parent_id').val(contribution_id);
      $('#contribution-title').html(title + ':');
      if (null != container) {
        container.append($('#contrib'));
      } else {
        $('#contribution_tool_container').append($('#contrib'));
      }
      $('#contrib').removeClass('hidden');
      init_tiny_mce('#contribution_content');
      scroll_to_contribution_tool();
    }

    function hide_contribution_tool() {
      $('#contribution-title').html('');
      $('#contrib').addClass('hidden');
    }

    function scroll_to_contribution_tool() {
      $('html, body').animate({
        scrollTop: $('#contrib').offset().top
      }, 500);
    }

    function scroll_to_element(element) {
      $('html, body').animate({
        scrollTop: element.offset().top
      }, 500);
    }

    function enable_post_to_conversation(element) {
      element.click(function(event) {
        event.preventDefault();
        clear_contribution_tool_form();
        var contribution_id = get_contribution_parent_id($(this));
        var title = $(this).attr('title');
        if (contribution_id) {
          show_contribution_tool($(this).parents('.respond-container'), contribution_id, title);
        } else {
          show_contribution_tool(null, null, title);
        }
        $('#contribution_content').tinymce().focus();
      });
    }

    $(document).ready(function() {

      enable_post_to_conversation($('.post_to_conversation'));

      $('#cancel-contribution').click(function(event) {
        event.preventDefault();
        hide_contribution_tool();
        scroll_to_element($(this).parents('.contribution-thread-div'));
      });

      $('#contribution-add-link').click(function(event) {
        event.preventDefault();
        $('#contribution_url').toggle();
        if ('none' != $('#contribution_url').css('display')) {
          $('#contribution_url').focus();
        } else {
          $('#contribution_content').tinymce().focus();
        }
      });

      $('#contribution-add-file').click(function(event) {
        event.preventDefault();
        $('#contribution_attachment').toggle();
        if ('none' != $('#contribution_attachment').css('display')) {
          $('#contribution_attachment').focus();
        } else {
          $('#contribution_content').tinymce().focus();
        }
      });

      init_tiny_mce('#contribution_content');

    })(); // end document ready function

    //]]>
  </script>

<% end %>

<div id="contrib" name="contrib" class="hidden" style="border-style: solid; border-width: 1px; border-color: #A9A9A9;text-align:left;">
  <%= form_for contribution, :as => :contribution, :url => conversation_contributions_path(conversation), :remote => true, :method => :post, :html => {:multipart => true} do |f| %>

    <p id='contribution-title--after-buggy-expand-and-collapse-is-fixed' style="font-weight:bold;">
      <div id='contribution-title' class="hack-to-prevent-old-expand-and-collapse-from-triggering" style="font-weight:bold;">
      </div>
    </p>

    <%= f.hidden_field(:parent_id) %>

    <fieldset>

      <p>
      <div class="hack-to-prevent-old-expand-and-collapse-from-triggering">
        <%= profile_image(current_person, 20, '') %>
      </div>
      </p>

      <p>
      <div class="hack-to-prevent-old-expand-and-collapse-from-triggering">
        <%= f.text_area(:content, :placeholder => "Leave a Comment...", :class => 'tinymce') %>
      </div>
      </p>

      <p>
      <div class="hack-to-prevent-old-expand-and-collapse-from-triggering">
        <a href="#" id="contribution-add-link">Add a link to a related website</a>
        <br />
        <%= f.text_field(:url, :type => "text", :class => "textbox link", :placeholder => "(Optional) Share a link...", :style => 'display:none;') %>
      </div>
      </p>

      <p>
      <div>
        <a href="#" id="contribution-add-file">Upload a photograph, document, or other file</a>
        <br />
        <%= f.file_field(:attachment, :style => 'display:none;') %>
      </div>
      </p>

    </fieldset>

    <fieldset>
      <p>
      <div class="hack-to-prevent-old-expand-and-collapse-from-triggering">
        <%= f.submit 'Leave my response', :class => 'submit' %>
        <%= link_to "Cancel", '#', :id => 'cancel-contribution' %>
      </div>
      </p>
    </fieldset>

  <% end %>
</div>
